<!DOCTYPE html>
<html lang="en">
<head>
	<title>panopo.ly</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="Stylesheet" href="panopoly.css" type="text/css">
	<link rel="Stylesheet" href="Cubemap.css" type="text/css">
</head>

	<body>
		<div id="info">
			panopo.ly
			<div id="Uptime" class="Button">0</div>

			<div id="ImageSelector" class="FileInput">
				Select Image
				<form id="uploaderform" enctype="multipart/form-data" method="POST">
					<input id="image_selector" name="image" type="file" />
				</form>
			</div>
			
			<div id="ImageUploader" class="FileInput">
				Upload Image<br />
				<input type="text" id="ImageUploader_CustomName" name="customname" class="cleardefault" value="custom url" />
				<input type="text" id="ImageUploader_Layout" name="layout" class="cleardefault" value="Layout" />
				<input type="button" value="Upload File"  onclick="UploadImage()"/>
				<progress id="progressBar" value="0" max="100" style="width:300px;"></progress>
				<h3 id="status"></h3>
				<p id="loaded_n_total"></p>
			</div>
			
			<div id="ClearButton" class="Button" onClick="forEach($Configs,function($Config){DestroyPano($Config);});">
				Clear
			</div>
			<div id="ShrinkButton" class="Button" onClick="SupportToggleEnable('Shrink')">
				Shrink
			</div>
			<div id="SplitButton" class="Button" onClick="ToggleSplit()">
				Stereo View
			</div>
			
			<div id="OculusBridgeButton" class="Button" onClick="SupportToggleEnable('OculusBridge')">
				OculusBridge
			</div>
			
			<div id="OculusRestButton" class="Button" onClick="SupportToggleEnable('OculusRest')">
				OculusRest
			</div>
			
			<div id="FullscreenButton" class="Button" onClick="SupportToggleEnable('Fullscreen')">
				Fullscreen
			</div>
			
			<div id="GyroButton" class="Button" onClick="SupportToggleEnable('Gyro')">
				Gyro
			</div>
			
			<div id="QuatDebug" class="Button">
				quaternion
			</div>
			
		</div>


		<script src="js/soy.js"></script>
		<script src="threejs/three.min.js"></script>
		<script src="threejs/renderers/CSS3DRenderer.js"></script>
		<script src="threejs/effects/StereoEffect.js"></script>
		<script src="js/GoogleAnalytics.js"></script>
		<script src="js/ClearDefaultText.js"></script>
		<script src="js/SoyWebSocket-1.0.js"></script>
		<script src="js/mjpeg.js"></script>
		<script src="js/SoyRect.js"></script>
		
		<script src="js/panopoly.js"></script>
		<script src="js/CubeMap.js"></script>
		<script src="js/support.js"></script>
		<script src="js/SoySupport.js"></script>
		<script src="js/SoyShrink.js"></script>
		<script src="js/SoyFullscreen.js"></script>
		<script src="js/SoyGyro.js"></script>
		<script src="js/SoyFileSelect.js"></script>
		<script src="js/SoyMouse.js"></script>
		<script src="js/SoyCss3d.js"></script>
		<script src="js/SoyWebgl.js"></script>
		<script src="js/SoyConfig.js"></script>
		<script src="js/SoyAsset.js"></script>
		<script src="js/SoyPano.js"></script>
	
		<script src="js/PanoMenu.js"></script>
	
	<script src="js/SoyAsset_GsvPanoMeta.js"></script>
	<script src="js/SoyAsset_GsvDepth.js"></script>
	<script src="js/SoyAsset_GsvImage.js"></script>
	<script src="js/SoyAsset_GsvPointCloud.js"></script>
		<script src="js/zpipe.min.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script>


<img id="image">
<div id="debug_console" style="overflow:scroll;height:200px;z-index:999;position:absolute;left:0;top:20px;opacity:0.5;background:white;"></div>
<div id="imagecontainer"></div>
<div id="container" style="width:900px;height:500px;background:lime;"></div>


<script id="pointcloudvertexshader" type="x-shader/x-vertex">
	
	
	varying vec4 vColor;
	uniform sampler2D DiffuseTexture;
	uniform sampler2D DepthTexture;
	
	//	from http://aras-p.info/blog/2009/07/30/encoding-floats-to-rgba-the-final/
	/*
	 vec4 EncodeFloatRGBA( float v )
	 {
	 vec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;
	 enc.x = frac(enc.x);
	 enc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);
	 return enc;
	 }
	 */
float DecodeFloatRGBA( vec4 rgba )
{
	return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );
}

float DecodeFloatRGB( vec4 rgba )
{
	return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 0.0) );
}

//	from my php code
vec3 VectorFromCoordsRad(vec2 latlon)
{
	//	http://en.wikipedia.org/wiki/N-vector#Converting_latitude.2Flongitude_to_n-vector
	float latitude = latlon.x;
	float longitude = latlon.y;
	float las = sin(latitude);
	float lac = cos(latitude);
	float los = sin(longitude);
	float loc = cos(longitude);
	
	return vec3( los * lac, las, loc * lac );
}
#define M_PI 3.1415926535897932384626433832795

vec2 GetLatLong(float x,float y,float Width,float Height)
{
	float xmul = 2.0;
	float xsub = 1.0;
	float ymul = 1.0;
	float ysub = 0.5;
	
	float xfract = x / Width;
	xfract *= xmul;
	
	//	float yfract = (Height - y) / Height;
	float yfract = (y) / Height;
	yfract *= ymul;
	
	float lon = ( xfract - xsub) * M_PI;
	float lat = ( yfract - ysub) * M_PI;
	return vec2( lat, lon );
}

float lerp(float From,float To,float Time)
{
	return From + (To-From)*Time;
}

void main()
{
	vec2 Diffuseuv = vec2( position.x,position.y );
	vec2 Depthuv = vec2( position.x,position.y );
	
	vec4 Depth4 = texture2D( DepthTexture, Depthuv );
	bool DepthInf = Depth4.w < 0.5;
	Depth4.w = 0.0;
	float Depthf = DepthInf ? 1.0 : DecodeFloatRGB( Depth4 );
	///Depthf = 1.0;
	//	lat lon to view
	vec3 View3 = VectorFromCoordsRad( GetLatLong(position.x, position.y,1.0,1.0) );
	View3 = normalize(View3);
	
	//	gr: eye seperation is 30... so near needs to be at least that!
	float Camera_Near = 2.0;
	float Camera_Far = 250.0;	//	at 260 some points start disapearing. not sure why Far is so low...
	
	float Near = 2.0;
	float ScaleFar = 200.0;
	float Scale = lerp( Near, ScaleFar, Depthf );
	
	float EyeScale = 1.0;
	View3 *= max(Camera_Near,min(Scale/EyeScale,Camera_Far));
	
	vec4 mvPosition = modelViewMatrix * vec4( View3, 1.0 );
	
	gl_PointSize = 4.0;
	
	gl_Position = projectionMatrix * mvPosition;
	
	vColor = texture2D( DiffuseTexture, Diffuseuv );
	
	if ( DepthInf )
	{
		gl_PointSize = 0.0;
		vColor.r = 1.0;
		vColor.g = 1.0;
		vColor.b = 1.0;
	}
	else
	{
		//vColor.r = 1.0-Depthf;
		//	vColor.g = 1.0-Depthf;
		//vColor.b = 1.0-Depthf;
	}
}



</script>

<script>
	BindConsole('debug_console');
	
	console.log('hello');
	

	var renderer, scene, camera, cloud, uniforms, attributes;
	
	
	function init($Container) {
		
		// renderer
		renderer = new THREE.WebGLRenderer();
		renderer.setSize( $Container.clientWidth, $Container.clientHeight );
		$Container.appendChild( renderer.domElement );
		
		// scene
		scene = new THREE.Scene();
		
		//camera
		camera = new THREE.PerspectiveCamera( 45, $Container.clientWidth / $Container.clientHeight, 1, 4000 );
		
		var $CameraScale = 10.0;
		camera.position.z = $CameraScale * 3.0;
		camera.position.y = $CameraScale * 4.0;
		camera.lookAt(new THREE.Vector3(0,0,0));
		
		cloud = $PointCloudAsset.mAsset;
		scene.add( cloud );
		return true;
	}

function animate() {
	
    requestAnimationFrame( animate );
	
    render();
	
}

function render() {
	
	/*
    for( var i = 0; i < attributes.alpha.value.length; i ++ ) {
		
        // dynamically change alphas
        attributes.alpha.value[ i ] *= 0.995;
        
        if ( attributes.alpha.value[ i ] < 0.2 ) {
            attributes.alpha.value[ i ] = 1.0;
        }
        
    }
	
    attributes.alpha.needsUpdate = true; // important!
	*/
   // cloud.rotation.x += 0.005;
    cloud.rotation.y += 0.005;
	
    renderer.render( scene, camera );
	
}











	function OnLoadPointCloud()
	{
		var $Result = init( GetElement('container') );
		if ( $Result !== true )
		{
			alert($Result);
			return false;
		}

		animate();
		return true;
	}

	function OnFailedLoad($Asset)
	{
		alert('failed to load point cloud');
	}


	var $LatLon = MatchLatLonString( window.location.hash, '#' );
	if ( $LatLon === false )
		$LatLon = [ 53.4838101,-2.2346764 ];
	var $PointCloudAsset = new SoyAsset_GsvPointCloud( $LatLon, OnLoadPointCloud, OnFailedLoad );

	</script>

	</body>
</html>
