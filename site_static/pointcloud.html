<!DOCTYPE html>
<html lang="en">
<head>
	<title>panopo.ly</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<link rel="Stylesheet" href="panopoly.css" type="text/css">
	<link rel="Stylesheet" href="Cubemap.css" type="text/css">
</head>

	<body>
		<div id="info">
			panopo.ly
			<div id="Uptime" class="Button">0</div>

			<div id="ImageSelector" class="FileInput">
				Select Image
				<form id="uploaderform" enctype="multipart/form-data" method="POST">
					<input id="image_selector" name="image" type="file" />
				</form>
			</div>
			
			<div id="ImageUploader" class="FileInput">
				Upload Image<br />
				<input type="text" id="ImageUploader_CustomName" name="customname" class="cleardefault" value="custom url" />
				<input type="text" id="ImageUploader_Layout" name="layout" class="cleardefault" value="Layout" />
				<input type="button" value="Upload File"  onclick="UploadImage()"/>
				<progress id="progressBar" value="0" max="100" style="width:300px;"></progress>
				<h3 id="status"></h3>
				<p id="loaded_n_total"></p>
			</div>
			
			<div id="ClearButton" class="Button" onClick="forEach($Configs,function($Config){DestroyPano($Config);});">
				Clear
			</div>
			<div id="ShrinkButton" class="Button" onClick="SupportToggleEnable('Shrink')">
				Shrink
			</div>
			<div id="SplitButton" class="Button" onClick="ToggleSplit()">
				Stereo View
			</div>
			
			<div id="OculusBridgeButton" class="Button" onClick="SupportToggleEnable('OculusBridge')">
				OculusBridge
			</div>
			
			<div id="OculusRestButton" class="Button" onClick="SupportToggleEnable('OculusRest')">
				OculusRest
			</div>
			
			<div id="FullscreenButton" class="Button" onClick="SupportToggleEnable('Fullscreen')">
				Fullscreen
			</div>
			
			<div id="GyroButton" class="Button" onClick="SupportToggleEnable('Gyro')">
				Gyro
			</div>
			
			<div id="QuatDebug" class="Button">
				quaternion
			</div>
			
		</div>


		<script src="js/soy.js"></script>
		<script src="threejs/three.min.js"></script>
		<script src="threejs/renderers/CSS3DRenderer.js"></script>
		<script src="threejs/effects/StereoEffect.js"></script>
		<script src="js/GoogleAnalytics.js"></script>
		<script src="js/ClearDefaultText.js"></script>
		<script src="js/SoyWebSocket-1.0.js"></script>
		<script src="js/mjpeg.js"></script>
		<script src="js/SoyRect.js"></script>
		
		<script src="js/panopoly.js"></script>
		<script src="js/CubeMap.js"></script>
		<script src="js/support.js"></script>
		<script src="js/SoySupport.js"></script>
		<script src="js/SoyOculusBridge.js"></script>
		<script src="js/SoyOculusRest.js"></script>
		<script src="js/SoyShrink.js"></script>
		<script src="js/SoyFullscreen.js"></script>
		<script src="js/SoyGyro.js"></script>
		<script src="js/SoyFileSelect.js"></script>
		<script src="js/SoyMouse.js"></script>
		<script src="js/SoyCss3d.js"></script>
		<script src="js/SoyWebgl.js"></script>
		<script src="js/SoyConfig.js"></script>
		<script src="js/SoyAsset.js"></script>
		<script src="js/SoyPano.js"></script>
	
		<script src="js/PanoMenu.js"></script>
	
	<script src="js/SoyAsset_GsvPanoMeta.js"></script>
	<script src="js/SoyAsset_GsvDepth.js"></script>
	<script src="js/SoyAsset_GsvImage.js"></script>
		<script src="js/zpipe.min.js"></script>
		<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false" type="text/javascript"></script>


<img id="image">
<div id="debug_console" style="overflow:scroll;height:200px;z-index:999;position:absolute;left:0;top:20px;opacity:0.5;background:white;"></div>
<div id="imagecontainer"></div>
<div id="container" style="width:900px;height:500px;background:lime;"></div>


<script>
	BindConsole('debug_console');
	
	console.log('hello');
	
	var $DepthLoaded = false;
	var $ImageLoaded = false;
	
	var $FragmentShader = null;	//	null=loading, false=failed, else content
	var $FragmentShaderAsset = new SoyAsset_Ajax('pointcloud.frag.glsl', function($Asset){ $FragmentShader = $Asset.mAsset; }, function($Asset){ $FragmentShader = false; } );
	var $VertexShader = null;	//	null=loading, false=failed, else content
	var $VertexShaderAsset = new SoyAsset_Ajax('pointcloud.vert.glsl', function($Asset){ $VertexShader = $Asset.mAsset; }, function($Asset){ $VertexShader = false; } );

	
	function CreatePointCloudMesh($w,$h,$VertexShader,$FragmentShader)
	{
		//	create 2D vertexes for each texel
		
		var geometry = new THREE.BufferGeometry();
		
		geometry.attributes = {
			
			position: {
				itemSize: 3,
				array: new Float32Array( $w * $h * 3 ),
				numItems: $w * $h * 3,
			},
			
		};
		
		var $i = 0;
		for ( var $y=0;	$y<$h;	$y++ )
		for ( var $x=0;	$x<$w;	$x++,$i+=geometry.attributes.position.itemSize )
		{
			geometry.attributes.position.array[$i+0] = $x/$w;
			geometry.attributes.position.array[$i+1] = $y/$h;
			geometry.attributes.position.array[$i+2] = 0;
		}
		
		geometry.boundingSphere = new THREE.Sphere( new THREE.Vector3(0,0,0), 1000 );

		var uniforms =
		{
			DiffuseTexture: { type: "t", value: THREE.ImageUtils.loadTexture( $ImageAsset.mAsset.src ) },
			DepthTexture: { type: "t", value: THREE.ImageUtils.loadTexture( $DepthAsset.mAsset.src ) },
		};
		

		var material = new THREE.ShaderMaterial( {
												uniforms: 		uniforms,
												vertexShader:   $VertexShader,
												fragmentShader: $FragmentShader,
												});
												
		var mesh = new THREE.PointCloud( geometry, material );
		return mesh;
	}



	var renderer, scene, camera, cloud, uniforms, attributes;
	
	
	function init($Container) {
		if ( $FragmentShader === false )
			return 'failed to load fragment shader';
		if ( $VertexShader === false )
			return 'failed to load vertex shader';
		
		if ( $FragmentShader === null )
		{
			setTimeout( OnLoadImageAndDepth, 200 );
			return 'still loading fragment shader';
		}
		if ( $VertexShader === null )
		{
			setTimeout( OnLoadImageAndDepth, 200 );
			return 'still loading vertex shader';
		}
		
		console.log("doing init");
		
		// renderer
		renderer = new THREE.WebGLRenderer();
		renderer.setSize( $Container.clientWidth, $Container.clientHeight );
		$Container.appendChild( renderer.domElement );
		
		// scene
		scene = new THREE.Scene();
		
		//camera
		camera = new THREE.PerspectiveCamera( 45, $Container.clientWidth / $Container.clientHeight, 1, 4000 );
		/*
		camera.position.z = 350.01;
		camera.position.y = 750.01;
		camera.lookAt(new THREE.Vector3(0,0,0));
		*/
		cloud = CreatePointCloudMesh(800,600, $VertexShader, $FragmentShader );
		if ( cloud === false || typeof cloud == 'string' )
			return cloud;
			
		scene.add( cloud );
		return true;
	}

function animate() {
	
    requestAnimationFrame( animate );
	
    render();
	
}

function render() {
	
	/*
    for( var i = 0; i < attributes.alpha.value.length; i ++ ) {
		
        // dynamically change alphas
        attributes.alpha.value[ i ] *= 0.995;
        
        if ( attributes.alpha.value[ i ] < 0.2 ) {
            attributes.alpha.value[ i ] = 1.0;
        }
        
    }
	
    attributes.alpha.needsUpdate = true; // important!
	*/
   // cloud.rotation.x += 0.005;
    cloud.rotation.y += 0.005;
	
    renderer.render( scene, camera );
	
}

















	function OnLoadImageAndDepth()
	{
		var $Result = init( GetElement('container') );
		if ( $Result !== true )
		{
			alert($Result);
			return false;
		}

		animate();
		return true;
	}

	function OnLoadDepth($Asset)
	{
		var $Div = document.createElement('div');
		var $Parent = GetElement('imagecontainer');
		$Parent.appendChild($Asset.mAsset);
		$DepthLoaded = true;
		if ( $DepthLoaded && $ImageLoaded )
			OnLoadImageAndDepth();
	}

	function OnFailedLoadDepth($Asset)
	{
	}

	function OnLoadImage($Asset)
	{
		var $Div = document.createElement('div');
		var $Parent = GetElement('imagecontainer');
		$Parent.appendChild($Asset.mAsset);
		$ImageLoaded = true;
		if ( $DepthLoaded && $ImageLoaded )
			OnLoadImageAndDepth();
	}

	function OnFailedLoadImage($Asset)
	{
	}


	var $LatLon = MatchLatLonString( window.location.hash, '#' );
	if ( $LatLon === false )
		$LatLon = [ 53.4838101,-2.2346764 ];
	var $DepthAsset = new SoyAsset_GsvDepth( $LatLon, OnLoadDepth, OnFailedLoadDepth );
	var $ImageAsset = new SoyAsset_GsvImage( $LatLon, OnLoadImage, OnFailedLoadImage );

	</script>

	</body>
</html>
